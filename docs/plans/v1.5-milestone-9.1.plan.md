# Milestone 9.1: Python Sync Client Refactor

## Status: COMPLETE

## Summary

Refactored the Python client from a flat Vibe/VibeSync model (~300 lines, 5 methods) to a full object model matching the JS client's API surface with Python conventions. The default import is now sync (`from vibium import browser`), with async moved to `from vibium.async_api import browser`.

## Architecture

- **Async is the foundation, sync wraps it** — async classes do the real work, sync wrappers use `_EventLoopThread`
- **`vibium:` command protocol** — all commands go through Go engine (no raw BiDi), matching JS client
- **BiDiClient event dispatch** — events (messages without `id`) dispatched to handlers
- **`find()` uses kwargs** — `vibe.find(role='button', text='Submit')`
- **Thin client** — no logic in Python, every method sends a command to Go engine

## File Structure

```
clients/python/src/vibium/
├── __init__.py              # from vibium import browser → sync
├── _types.py                # BoundingBox, ElementInfo, type aliases
├── _sync_base.py            # _EventLoopThread
├── binary.py                # VibiumProcess (unchanged)
├── client.py                # BiDiClient (extended with event dispatch)
├── cli.py                   # CLI entry point (unchanged)
│
├── async_api/               # Async implementation (foundation)
│   ├── __init__.py          # from vibium.async_api import browser
│   ├── browser.py           # Browser class + launcher
│   ├── page.py              # Page, Keyboard, Mouse, Touch
│   ├── element.py           # Element
│   ├── element_list.py      # ElementList
│   ├── context.py           # BrowserContext
│   ├── clock.py             # Clock
│   ├── tracing.py           # Tracing
│   ├── dialog.py            # Dialog
│   ├── route.py             # Route
│   ├── network.py           # Request, Response
│   ├── download.py          # Download
│   ├── console.py           # ConsoleMessage
│   └── websocket_info.py    # WebSocketInfo
│
└── sync_api/                # Sync wrappers
    ├── __init__.py
    ├── browser.py           # Browser + launcher
    ├── page.py              # Page, Keyboard, Mouse, Touch
    ├── element.py           # Element
    ├── element_list.py      # ElementList
    ├── context.py           # BrowserContext
    ├── clock.py             # Clock
    ├── tracing.py           # Tracing
    ├── route.py             # Route (decision pattern)
    └── dialog.py            # Dialog (decision pattern)
```

## Deleted Files
- `vibe.py` — replaced by async_api/page.py
- `browser.py` — replaced by async_api/browser.py
- `browser_sync.py` — replaced by sync_api/browser.py
- `element.py` — replaced by async_api/element.py + _types.py

## Commands Implemented

### Browser
- [x] `vibium:browser.page`, `vibium:browser.newPage`, `vibium:browser.newContext`
- [x] `vibium:browser.pages`, `vibium:browser.close`

### Page Navigation
- [x] `vibium:page.navigate`, `vibium:page.back`, `vibium:page.forward`, `vibium:page.reload`
- [x] `vibium:page.url`, `vibium:page.title`, `vibium:page.content`
- [x] `vibium:page.waitForURL`, `vibium:page.waitForLoad`

### Finding
- [x] `vibium:find` (CSS + semantic kwargs), `vibium:findAll`, `vibium:page.waitFor`

### Element Interaction (17 commands)
- [x] click, dblclick, fill, type, press, clear, check, uncheck
- [x] selectOption, hover, focus, dragTo, tap, scrollIntoView
- [x] dispatchEvent, el.setFiles

### Element State (17 commands)
- [x] el.text, el.innerText, el.html, el.value, el.attr
- [x] el.bounds, el.isVisible, el.isHidden, el.isEnabled
- [x] el.isChecked, el.isEditable, el.role, el.label
- [x] el.eval, el.screenshot, el.waitFor

### Input
- [x] keyboard.press, keyboard.down, keyboard.up, keyboard.type
- [x] mouse.click, mouse.move, mouse.down, mouse.up, mouse.wheel
- [x] touch.tap

### Page Features
- [x] screenshot, pdf, eval, evalHandle, addScript, addStyle, expose
- [x] setViewport, viewport, emulateMedia, setContent, setGeolocation
- [x] setWindow, window, a11yTree, wait, waitForFunction
- [x] frames, frame, bringToFront, close

### Network
- [x] page.route (with handler), unroute, setHeaders
- [x] waitForRequest, waitForResponse
- [x] onRequest, onResponse

### Events
- [x] onDialog (accept/dismiss/callable), onConsole, onError
- [x] onDownload, onWebSocket, removeAllListeners

### Context
- [x] context.newPage, context.close, context.cookies
- [x] context.setCookies, context.clearCookies
- [x] context.storageState, context.addInitScript

### Clock
- [x] clock.install, clock.fastForward, clock.runFor, clock.pauseAt
- [x] clock.resume, clock.setFixedTime, clock.setSystemTime, clock.setTimezone

### Tracing
- [x] tracing.start, tracing.stop, tracing.startChunk, tracing.stopChunk
- [x] tracing.startGroup, tracing.stopGroup

## Sync-Specific Patterns

### Dialog handling
```python
vibe.on_dialog('accept')       # Simple string
vibe.on_dialog('dismiss')
vibe.on_dialog(lambda d: d.accept('yes'))  # Callable with decision pattern
```

### Route handling
```python
vibe.route('**/*.png', 'abort')                    # String action
vibe.route('**/api/*', {'status': 200, 'body': '{}'})  # Dict fulfill
vibe.route('**', lambda r: r.continue_())          # Callable with decision pattern
```

### Console/Error collecting
```python
vibe.on_console('collect')
# ... do stuff ...
msgs = vibe.console_messages()  # Returns list of {type, text}
```

## Breaking Changes
- `from vibium import browser` now returns sync launcher (was async)
- `from vibium import browser_sync` removed
- `Vibe`/`VibeSync` classes replaced by `Page`
- `vibe.evaluate()` replaced by `vibe.eval()`
- `vibe.quit()` replaced by `bro.close()`
- `vibe.find(selector)` still works, but kwargs added for semantic finding
